<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Engine API - OpenAI Style UI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: #343541;
            color: #ececf1;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #202123;
            padding: 1rem 2rem;
            border-bottom: 1px solid #4a4a4a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .header .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10a37f;
        }

        .container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 260px;
            background: #202123;
            border-right: 1px solid #4a4a4a;
            padding: 1rem;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #8e8ea0;
        }

        .endpoint-list {
            list-style: none;
        }

        .endpoint-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .endpoint-item:hover {
            background: #343541;
        }

        .endpoint-item.active {
            background: #343541;
        }

        .endpoint-item .method {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .method.get { background: #10a37f; color: white; }
        .method.post { background: #19c37d; color: white; }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .avatar {
            background: #19c37d;
        }

        .message.assistant .avatar {
            background: #5436da;
        }

        .message-content {
            flex: 1;
            background: #444654;
            padding: 1rem;
            border-radius: 8px;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: #2f2f2f;
        }

        .input-area {
            padding: 1.5rem 2rem;
            background: #202123;
            border-top: 1px solid #4a4a4a;
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        textarea {
            width: 100%;
            background: #40414f;
            border: 1px solid #565869;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            color: #ececf1;
            font-size: 1rem;
            resize: none;
            min-height: 52px;
            max-height: 200px;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: #10a37f;
        }

        .params-panel {
            background: #40414f;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .params-panel.active {
            display: block;
        }

        .param-group {
            margin-bottom: 1rem;
        }

        .param-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #8e8ea0;
        }

        .param-group input,
        .param-group select {
            width: 100%;
            padding: 0.5rem;
            background: #565869;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            color: #ececf1;
            font-size: 0.9rem;
        }

        button {
            background: #19c37d;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #10a37f;
        }

        button:disabled {
            background: #565869;
            cursor: not-allowed;
        }

        .response-json {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #8e8ea0;
            border-top-color: #19c37d;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            color: #ef4444;
            background: #7f1d1d;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>RAG Engine API</h1>
        <div class="status">
            <div class="status-indicator"></div>
            <span>API Running</span>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <h2>Endpoints</h2>
            <ul class="endpoint-list">
                <li class="endpoint-item active" data-endpoint="chat">
                    <span class="method post">POST</span>
                    <span>/chat</span>
                </li>
                <li class="endpoint-item" data-endpoint="query">
                    <span class="method post">POST</span>
                    <span>/query</span>
                </li>
                <li class="endpoint-item" data-endpoint="content">
                    <span class="method post">POST</span>
                    <span>/content</span>
                </li>
                <li class="endpoint-item" data-endpoint="health">
                    <span class="method get">GET</span>
                    <span>/health</span>
                </li>
            </ul>
        </div>

        <div class="main-content">
            <div class="chat-area" id="chatArea">
                <div class="message assistant">
                    <div class="avatar">API</div>
                    <div class="message-content">
                        <p>Welcome to the RAG Engine API! Select an endpoint from the sidebar to get started.</p>
                        <p style="margin-top: 0.5rem; color: #8e8ea0; font-size: 0.9rem;">
                            • <strong>POST /chat</strong> - Conversational chat with AI using RAG context (Gemini Flash)<br>
                            • <strong>POST /query</strong> - Search for similar content<br>
                            • <strong>POST /content</strong> - Add new content to the database<br>
                            • <strong>GET /health</strong> - Check API health status
                        </p>
                        <p style="margin-top: 0.5rem; color: #8e8ea0; font-size: 0.85rem;">
                            <em>The chat maintains conversation history - previous messages provide context for better responses!</em>
                        </p>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div id="paramsPanel" class="params-panel">
                    <div class="param-group">
                        <label>Search Type</label>
                        <select id="searchType">
                            <option value="cosine">Cosine Similarity</option>
                            <option value="l2">L2 Distance</option>
                            <option value="inner_product">Inner Product</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label>Top K Results</label>
                        <input type="number" id="topK" value="5" min="1" max="100">
                    </div>
                    <div class="param-group">
                        <label>Threshold (optional)</label>
                        <input type="number" id="threshold" step="0.1" placeholder="0.5">
                    </div>
                </div>
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea id="userInput" placeholder="Enter your query or content here..." rows="1"></textarea>
                    </div>
                    <button id="sendButton" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentEndpoint = 'chat';
        let conversationHistory = []; // Store conversation history

        // Initialize
        document.querySelectorAll('.endpoint-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.endpoint-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                currentEndpoint = item.dataset.endpoint;
                updateUI();
                // Clear conversation history when switching away from chat
                if (currentEndpoint !== 'chat') {
                    conversationHistory = [];
                }
            });
        });

        function updateUI() {
            const paramsPanel = document.getElementById('paramsPanel');
            const input = document.getElementById('userInput');
            
            if (currentEndpoint === 'chat') {
                paramsPanel.classList.add('active');
                document.getElementById('searchType').parentElement.style.display = 'block';
                input.placeholder = 'Ask me anything! I\'ll use RAG to find relevant context and answer...';
            } else if (currentEndpoint === 'query') {
                paramsPanel.classList.add('active');
                document.getElementById('searchType').parentElement.style.display = 'block';
                input.placeholder = 'Enter your search query...';
            } else if (currentEndpoint === 'content') {
                paramsPanel.classList.remove('active');
                input.placeholder = 'Enter content to add to the database...';
            } else {
                paramsPanel.classList.remove('active');
                input.placeholder = 'Click Send to check health status...';
            }
        }

        function addMessage(role, content, isJson = false) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = role === 'user' ? 'You' : 'API';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isJson) {
                const jsonDiv = document.createElement('div');
                jsonDiv.className = 'response-json';
                jsonDiv.textContent = JSON.stringify(content, null, 2);
                contentDiv.appendChild(jsonDiv);
            } else {
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const button = document.getElementById('sendButton');
            const query = input.value.trim();
            
            if (!query && currentEndpoint !== 'health') {
                return;
            }

            // Add user message
            if (currentEndpoint !== 'health') {
                addMessage('user', query);
            }
            
            input.value = '';
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span>';

            try {
                let response;
                
                if (currentEndpoint === 'chat') {
                    // Build conversation history for the API
                    const history = conversationHistory.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));
                    
                    const payload = {
                        message: query,
                        conversation_history: history,
                        search_type: document.getElementById('searchType').value,
                        top_k: parseInt(document.getElementById('topK').value),
                        temperature: 0.7
                    };
                    
                    const threshold = document.getElementById('threshold').value;
                    if (threshold) {
                        payload.threshold = parseFloat(threshold);
                    }
                    
                    response = await fetch(`${API_BASE}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                } else if (currentEndpoint === 'query') {
                    const payload = {
                        query: query,
                        search_type: document.getElementById('searchType').value,
                        top_k: parseInt(document.getElementById('topK').value),
                    };
                    
                    const threshold = document.getElementById('threshold').value;
                    if (threshold) {
                        payload.threshold = parseFloat(threshold);
                    }
                    
                    response = await fetch(`${API_BASE}/query`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                } else if (currentEndpoint === 'content') {
                    response = await fetch(`${API_BASE}/content`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            content: query,
                            document_id: `doc_${Date.now()}`,
                            chunk_index: 0
                        })
                    });
                    
                } else if (currentEndpoint === 'health') {
                    response = await fetch(`${API_BASE}/health`);
                }

                const data = await response.json();
                
                if (response.ok) {
                    if (currentEndpoint === 'chat') {
                        // For chat, show response naturally
                        let chatResponse = data.response;
                        if (data.context_used > 0) {
                            chatResponse += `\n\n[Used ${data.context_used} context chunks from knowledge base]`;
                        }
                        addMessage('assistant', chatResponse);
                        
                        // Add to conversation history
                        conversationHistory.push({ role: 'user', content: query });
                        conversationHistory.push({ role: 'assistant', content: data.response });
                        
                        // Keep only last 10 exchanges to avoid token limits
                        if (conversationHistory.length > 20) {
                            conversationHistory = conversationHistory.slice(-20);
                        }
                    } else {
                        addMessage('assistant', '', true);
                        // Update the last message with formatted JSON
                        const lastMessage = document.querySelector('.message.assistant:last-child .message-content');
                        lastMessage.innerHTML = '<div class="response-json">' + JSON.stringify(data, null, 2) + '</div>';
                    }
                } else {
                    addMessage('assistant', `Error: ${data.detail || 'Unknown error'}`);
                }
                
            } catch (error) {
                addMessage('assistant', `Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Send';
            }
        }

        // Enter key to send
        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('userInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        updateUI();
    </script>
</head>
</html>

